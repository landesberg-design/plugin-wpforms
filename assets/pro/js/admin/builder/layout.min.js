"use strict";var WPForms=window.WPForms||{};WPForms.Admin=WPForms.Admin||{},WPForms.Admin.Builder=WPForms.Admin.Builder||{},WPForms.Admin.Builder.FieldLayout=WPForms.Admin.Builder.FieldLayout||function(a){let f={};const p={init:function(){a(p.ready)},ready:function(){p.setup(),p.initLabels(),p.events(),p.rowDisplayHeightBalance(a(".wpforms-field-layout-columns.wpforms-layout-display-rows"))},setup:function(){f={$builder:a("#wpforms-builder"),$fieldOptions:a("#wpforms-field-options"),$sortableFieldsWrap:a("#wpforms-panel-fields .wpforms-field-wrap")}},events(){f.$builder.on("change",".wpforms-field-option-row-preset input",p.presetChange).on("change",".wpforms-field-option-row-display select",p.displayChange).on("mouseenter",".wpforms-field-layout .wpforms-field",p.subfieldMouseEnter).on("mouseleave",".wpforms-field-layout .wpforms-field",p.subfieldMouseLeave).on("wpformsFieldAddDragStart",p.fieldCantAddModal).on("wpformsFieldAdd",p.fieldAdd).on("wpformsBeforeFieldAddToDOM",p.beforeFieldAddToDOM).on("wpformsBeforeFieldAddOnClick",p.beforeFieldAddOnClick).on("wpformsBeforeFieldDelete",p.beforeFieldDelete).on("wpformsBeforeFieldDeleteAlert",p.adjustDeleteFieldAlert).on("wpformsFieldOptionTabToggle",p.fieldOptionsUpdate).on("wpformsFieldMoveRejected",p.fieldMoveRejected).on("wpformsBeforeFieldDuplicate",p.beforeFieldDuplicate).on("wpformsFieldDuplicated",p.fieldDuplicated).on("wpformsFieldDelete",p.handleFieldDelete).on("wpformsFieldAdd wpformsFieldChoiceAdd wpformsFieldChoiceDelete wpformsFieldDynamicChoiceToggle wpformsFieldLayoutChangeDisplay",p.handleFieldOperations).on("wpformsFieldMoveRejected",p.handleFieldMoveRejected).on("wpformsFieldMove",p.handleFieldMove).on("wpformsFieldDragOver wpformsFieldDragChange",p.handleFieldDrag)},handleFieldDelete(e,o,l,i){0!==i.length&&i.hasClass("wpforms-layout-display-rows")&&p.rowDisplayHeightBalance(i)},handleFieldOperations(e,o){o=a("#wpforms-field-"+o);0!==o.find(".wpforms-layout-display-rows").length&&p.rowDisplayHeightBalance(o.find(".wpforms-layout-display-rows"))},handleFieldMoveRejected(e,o){o=o.prev(".wpforms-field, .wpforms-alert").data("field-id"),o=a("#wpforms-field-"+o);0!==o.find(".wpforms-layout-display-rows").length&&p.rowDisplayHeightBalance(o.find(".wpforms-layout-display-rows"))},handleFieldMove(e,o){o=o.item.first();0!==o.parents(".wpforms-layout-display-rows").length&&p.rowDisplayHeightBalance(o.parents(".wpforms-layout-display-rows"))},handleFieldDrag(e,o,l){l.hasClass("wpforms-layout-column")&&p.rowDisplayHeightBalance(l.parents(".wpforms-layout-display-rows"))},displayChange(){var e=a(this),o=e.val(),l=e.closest(".wpforms-field-option-row-display").data("field-id"),i=a("#wpforms-field-"+l).find(".wpforms-field-layout-columns");e.closest(".wpforms-field-option-row-display").parent().find(".wpforms-field-option-row-preset").toggleClass("wpforms-layout-display-rows","rows"===o),i.toggleClass("wpforms-layout-display-rows","rows"===o).toggleClass("wpforms-layout-display-columns","columns"===o).find(".wpforms-field").css("margin-bottom","columns"===o?5:""),f.$builder.trigger("wpformsFieldLayoutChangeDisplay",[l])},rowDisplayHeightBalance(e){e.each(function(){var e=a(this);const l=[];e.find(".wpforms-field, .wpforms-field-drag-placeholder").each(function(){var e=a(this),o=e.index();l[o]=Math.max(l[o]||0,e.outerHeight())}),e.find(".wpforms-field, .wpforms-field-drag-placeholder").each(function(){var e=a(this);e.css("margin-bottom",l[e.index()]-e.outerHeight()+5)})})},presetChange:function(e){var o=a(this),l=o.val(),o=o.closest(".wpforms-field-option-row-preset").data("field-id"),i=a("#wpforms-field-"+o),t=i.find(".wpforms-field-layout-columns");let d=[],r=(t.find(".wpforms-layout-column").each(function(e){d[e]=a(this).find(".wpforms-field").detach()}),p.getFieldColumnsData(o)),s=l.split("-").map(function(e,o){return{width_preset:e,fields:r[o]?r[o].fields:[]}});if(p.updateFieldColumnsData(o,s),t.html(p.generatePreviewColumns(s)),t.find(".wpforms-layout-column").each(function(e){var o=a(this);o.append(d[e]),WPForms.Admin.Builder.DragFields.initSortableContainer(o)}),s.length<r.length){let o=a([]);for(let e=s.length;e<r.length;e++)o=o.add(d[e]);i.after(o)}p.reorderLayoutFieldsOptions(i),f.$builder.trigger("wpformsLayoutAfterPresetChange",{fieldId:o,preset:l,newColumnsData:s,oldColumnsData:r})},generatePreviewColumns:function(e){if(!e||!e.length)return"";const o=wp.template("wpforms-layout-field-column-plus-placeholder-template")();return e.map(function(e){return`<div class="wpforms-layout-column wpforms-layout-column-${e.width_preset}">
							${o}
						</div>`}).join("")},getFieldColumnsData:function(e){let o=a(`#wpforms-field-option-${e}-columns-json`).val(),l;try{l=JSON.parse(o)}catch(e){l=[]}return l},columnsHasFieldID:function(e,o){return 0<p.getFieldColumnsData(e).filter(function(e){return e.fields.includes(o)}).length},updateFieldColumnsData:function(e,o){var l=a(`#wpforms-field-option-${e}-columns-json`),i=l.val(),t=JSON.stringify(o);l.val(t),i!==t&&f.$builder.trigger("wpformsLayoutColumnsDataUpdated",{fieldId:e,data:o}),f.$builder.trigger("wpformsLayoutAfterUpdateColumnsData",{fieldId:e,data:o})},beforeFieldAddToDOM:function(e,o,l,i,t){t&&t.length&&t.hasClass("wpforms-layout-column")&&(e.skipAddFieldToBaseLevel=!0,p.fieldAddToColumn(l,i,o.position,t))},fieldAdd:function(e,o,l){var i=a("#wpforms-field-option-"+o).prev();"layout"===i.find(".wpforms-field-option-hidden-type").val()&&(i=i.find(".wpforms-field-option-hidden-id").val(),p.reorderLayoutFieldsOptions(a("#wpforms-field-"+i))),"layout"===l&&f.$builder.find(`#wpforms-field-${o} .wpforms-layout-column`).each(function(){WPForms.Admin.Builder.DragFields.initSortableContainer(a(this))})},beforeFieldAddOnClick:function(e,o,l){p.fieldCantAddModal(e,o,{}),e.isDefaultPrevented()||p.isFieldAllowedInColum(o)||f.$sortableFieldsWrap.find(".wpforms-fields-sortable-default").length&&(e.preventDefault(),p.fieldMoveRejected(e,l,null))},beforeFieldDelete:function(e,o,l){"layout"!==l?(p.removeFieldFromColumns(o),a("#wpforms-field-"+o).closest(".wpforms-field-layout").removeClass("wpforms-field-child-hovered")):p.getFieldColumnsData(o).forEach(function(e){Array.isArray(e.fields)&&e.fields.forEach(function(e){WPFormsBuilder.fieldDeleteById(e)})})},adjustDeleteFieldAlert:function(e,o,l){"layout"===l&&(e.preventDefault(),a.confirm({title:!1,content:wpforms_builder.layout.delete_confirm,icon:"fa fa-exclamation-circle",type:"orange",buttons:{confirm:{text:wpforms_builder.ok,btnClass:"btn-confirm",keys:["enter"],action:function(){WPFormsBuilder.fieldDeleteById(o.id)}},cancel:{text:wpforms_builder.cancel}}}))},fieldOptionsUpdate:function(e,o){p.fieldLegacyLayoutSelectorUpdate(o),p.fieldSizeOptionUpdate(o),p.fieldOptionGroupsToggle(o)},fieldLegacyLayoutSelectorUpdate:function(e){var o,e=a(`#wpforms-field-option-row-${e}-css .layout-selector-display`);e.find(".wpforms-alert-layout").length||(o=a(`
				<div class="wpforms-alert-warning wpforms-alert-layout wpforms-alert wpforms-alert-nomargin">
					<h4>${wpforms_builder.layout.legacy_layout_notice_title}</h4>
					<p>${wpforms_builder.layout.legacy_layout_notice_text}</p>
				</div>
			`),e.append(o),e.find(".heading, .layouts").addClass("wpforms-hidden-strict"))},fieldSizeOptionUpdate:function(e){var o=a("#wpforms-field-"+e),l=o.data("field-type"),o=0<o.closest(".wpforms-field-layout").length,e=a(`#wpforms-field-option-row-${e}-size`),i=e.find("select");let t=e.find(".wpforms-notice-field-size");-1<["textarea","richtext"].indexOf(l)||(t.length||(t=a(`
					<label class="sub-label wpforms-notice-field-size" title="${wpforms_builder.layout.size_notice_tooltip}">
						${wpforms_builder.layout.size_notice_text}
					</label>
				`),e.append(t)),o?i.attr("title",wpforms_builder.layout.size_notice_tooltip):i.attr("title",""),i.toggleClass("wpforms-disabled",o),t.toggleClass("wpforms-hidden",!o))},fieldOptionGroupsToggle:function(e){e=a("#wpforms-field-"+e).data("field-type");f.$fieldOptions.toggleClass("wpforms-hide-options-groups","layout"===e)},receiveFieldToColumn:function(e,o,l){p.removeFieldFromColumns(e),l&&l.hasClass("wpforms-layout-column")&&(p.positionFieldInColumn(e,o,l),p.fieldOptionsUpdate(null,e),f.$builder.trigger("wpformsLayoutAfterReceiveFieldToColumn",{fieldId:e,position:o,column:l}))},removeFieldFromColumns:function(l){l=Number(l),f.$builder.find(".wpforms-field").each(function(){var e=a(this);if("layout"===e.data("field-type")){var e=Number(e.data("field-id")),o=p.getFieldColumnsData(e);for(let e=0;e<o.length;e++)Array.isArray(o[e].fields)&&(o[e].fields=o[e].fields.filter(function(e){return Number(e)!==l}));p.updateFieldColumnsData(e,o)}})},positionFieldInColumn:function(o,e,l){var i,t,d;l&&l.hasClass("wpforms-layout-column")&&(i=l.closest(".wpforms-field-layout").data("field-id"),l=l.index(),t=p.getFieldColumnsData(i))&&t[l]&&((d=t[l]).fields=Array.isArray(d.fields)?d.fields:[],o=Number(o),d.fields=d.fields.filter(function(e){return Number(e)!==o}),d.fields.splice(e,0,o),t[l]=d,p.updateFieldColumnsData(i,t))},duplicateLayoutField:function(e){var o=a("#wpforms-field-"+e),l=a(`#wpforms-field-option-${e} .wpforms-field-option-row-preset input:checked`).val();if("layout"===o.data("field-type")){const i=p.getFieldColumnsData(e),t=WPFormsBuilder.fieldDuplicateRoutine(e),r=a("#wpforms-field-"+t),s=a("#wpforms-field-option-"+t),n=r.find(".wpforms-layout-column");let d=JSON.parse(JSON.stringify(i));s.find(`#wpforms-field-option-${t}-preset-`+l).prop("checked",!0),r.find(".wpforms-layout-column .wpforms-field").remove(),r.find(".wpforms-fields-sortable-default").removeClass("wpforms-fields-sortable-default"),i.forEach(function(e,i){d[i].fields=[];let t=n.eq(i);e.fields.forEach(function(e){var o,l=a("#wpforms-field-"+e);l.length&&l.find("> .wpforms-field-duplicate").length&&(l=WPFormsBuilder.fieldDuplicateRoutine(e),e=a("#wpforms-field-"+l).detach().removeClass("active"),o=a("#wpforms-field-option-"+l),t.append(e),o.hide(),d[i].fields.push(l))})}),p.updateFieldColumnsData(t,d),p.reorderLayoutFieldsOptions(r),r.trigger("click"),WPFormsUtils.triggerEvent(f.$builder,"wpformsFieldDuplicated",[e,o,t,r])}},subfieldMouseEnter:function(e){a(this).closest(".wpforms-field-layout").addClass("wpforms-field-child-hovered")},subfieldMouseLeave:function(e){a(this).closest(".wpforms-field-layout").removeClass("wpforms-field-child-hovered")},initLabels:function(){a(".wpforms-field-option-layout .wpforms-field-option-row-label input").trigger("input")},fieldAddToColumn:function(e,o,l,i){var t=i.find(".wpforms-field"),t=("bottom"===l&&(l=t.length),t.eq(l)),d=t.data("field-id"),t=(t.length?t.before(e):i.append(e),a("#wpforms-field-option-"+d));t.length?t.before(o):f.$fieldOptions.append(o),p.receiveFieldToColumn(e.data("field-id"),l,i),p.reorderLayoutFieldsOptions(i.closest(".wpforms-field-layout"))},fieldMoveRejected:function(e,o,l){var i=o.data("field-type"),i=(i?a("#wpforms-add-fields-"+i):o).text();a.confirm({title:wpforms_builder.heads_up,content:wpforms_builder.layout.not_allowed_alert_text.replace(/%s/g,`<strong>${i}</strong>`),icon:"fa fa-exclamation-circle",type:"red",buttons:{confirm:{text:wpforms_builder.ok,btnClass:"btn-confirm",keys:["enter"]}}})},fieldCantAddModal:function(o,e,l){if("layout"===e){let e="";""!==(e=a("#wpforms-panel-field-settings-conversational_forms_enable").is(":checked")?wpforms_builder.layout.enabled_cf_alert_text:e)&&(o.preventDefault(),a.confirm({title:wpforms_builder.heads_up,content:e,icon:"fa fa-exclamation-circle",type:"orange",buttons:{confirm:{text:wpforms_builder.ok,btnClass:"btn-confirm",keys:["enter"]}}}))}},reorderLayoutFieldsOptions:function(e){if(e&&e.length&&"layout"===e.data("field-type")){const o=e.data("field-id"),l=p.getFieldColumnsData(o);let t=a("#wpforms-field-option-"+o);l.forEach(function(e,o){if(Array.isArray(e.fields)){let i=e.fields.slice();e.fields.forEach(function(e,o){let l=a("#wpforms-field-option-"+e);l.length?(l=l.detach(),t.after(l),t=l):-1!==(e=i.indexOf(e))&&i.splice(e,1)}),e.fields=i,l[o]=e}}),p.updateFieldColumnsData(o,l)}},isFieldAllowedInColum:function(e){return wpforms_builder.layout.not_allowed_fields.indexOf(e)<0},beforeFieldDuplicate:function(e,o,l){"layout"===l.data("field-type")&&(e.preventDefault(),p.duplicateLayoutField(o),WPFormsBuilder.increaseNextFieldIdAjaxRequest())},fieldDuplicated:function(e,o,l,i,t){"layout"!==l.data("field-type")&&p.positionFieldInColumn(i,t.index()-1,t.parent())}};return p}((document,window,jQuery)),WPForms.Admin.Builder.FieldLayout.init();